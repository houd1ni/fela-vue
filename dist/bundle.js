"use strict";var e=require("pepka"),s=require("fela"),t=require("fela-dom"),r=require("fela-plugin-embedded"),n=require("fela-plugin-prefixer"),l=require("fela-plugin-fallback-value"),c=require("fela-plugin-unit");const i=Object.freeze({}),a=Object.freeze({f:"function",o:"object",s:"string"}),o=e=>e.replace(/-(\w)/gu,((e,s)=>s.toUpperCase())),u=(()=>{const e=/url\(.*?\)/g,s=/[,:;]/g;return t=>t.replace(e,(e=>e.replace(s,(e=>`\\${e}`))))})(),p=e.when(e.complement(e.isNil),e.replace(/([^\\])\\([^\\])/g,"$1$2")),f=e.both(e.complement(e.isEmpty),e.complement(e.isNil)),h=e.compose(e.equals("Object"),e.type),d=e.compose(e.equals("Window"),e.type),m=(e,s)=>{for(let t in s)h(e[t])&&h(s[t])?m(e[t],s[t]):e[t]=s[t];return e},g=(()=>{try{return d(window)}catch{return!1}})();class y{s;rules={};get complex(){return null!==this.s.className&&null!==this.s.modifier}serialize(){const{className:e,modifier:s}=this.s;return(e?`.${e}`:"")+(s||"")}constructor(e){const s=e.match(/^\.[\w-_]+/);this.s={className:s?s[0].slice(1):null,modifier:s?e.slice(s[0].length)||null:e}}}const w=(e,s=0)=>{const t={};let r,n,l,c,i;for(i in e.rules)r=e.rules[i],r instanceof y?(n=r.complex?r.s.className:r.serialize(),l=0==s&&"."==n[0]?n.slice(1):"."==n[0]?`& ${n}`:n,c=r.complex?{[r.s.modifier]:w(r,s+1)}:w(r,s+1),t[l]?m(t[l],c):t[l]=c):t[i]=r;return t};class ${path=[];get out(){return w(this.path[0][0])}get depth(){return this.path.length}add(s){const t=e.last(this.path),r=[];for(const e of s){const s=new y(e);for(const e of t){const t=s.serialize(),n=e.rules[t];r.push(n||s),n||(e.rules[t]=s)}}this.path.push(r)}merge(s,t){if(f(t)&&f(s))for(const r of e.last(this.path))r.rules[s]=t}pop(){return this.path.pop()}constructor(){this.path.push([new y("__root")])}}const b=(()=>{const s=/^([\w-]+)(: *| +)(.*)$/,t=/^(([\|~\$@>\*\.:&\(\)\^="\-\[\]]+).*[ ,]*)+:?$/,r=/\s*,\s*/g,n=/(.*):$/;return(l,c,i)=>{let a;switch(!0){case"{"==c:l.add(i);break;case"}"==c:l.pop();break;case null!=(a=s.exec(c)):l.merge(p(o(a[1])),e.when(isNaN,p,(e=>{switch(e){case"undefined":case"":return;case"null":return null;default:return isNaN(+e)?e:+e}})(a[3])));break;case null!=(a=t.exec(c)):i.splice(0),i.push(...c.split(r).map((e=>e.replace(n,"$1"))))}}})(),x=e.curry((([e,s],t)=>{let r,n,l=t.length,c=e.length,i=0,a=[];for(r=0;r<l;r++)switch(t.slice(r,r+c)){case e:r+=c-1,0==i&&(n=r),i++;break;case s:if(r+=c-1,i--,0==i)a.push([n,r]);else if(i<0)throw new Error("fela-vue literal: unbalanced delimeter in functional expression !")}return a})),N=e.compose(e.join("\n"),e.map((e=>{const s=[];let t=0;for(let[r,n]of x(["[","]"],e))s.push(e.slice(t,r),`\${${e.slice(r+1,n).replace(/(\W|^)\$([a-zA-Z_]+)\b/g,"$1$$ps.$2").replace(/(\W|^)@(.+?)\b/g,"$1$t.$2")}}`),t=n+1;return s.push(e.slice(t)),s.join("")}))),v=e=>{const s=[];let t,r,n,l=0,c=[];for(t of e)if(l>0)switch(t){case"{":l++,c[c.length-1]+=t;break;case"}":if(1==--l){const e=new Function("$t,css,$ps",`return css\`\n                ${N(c)}\n              \``);s.push([n,(s,t)=>e(t,k,s)]),l=0,c.splice(0)}else c[c.length-1]+=t;break;default:c.push(t)}else r=t.indexOf("=>"),~r?(l=1,n=t.slice(0,r).trim().replace(/^\./,"")):s.push(t);return s},S=(()=>{const s=["\n","\r",";"],t=e=>s.includes(e),r=/(([\s^]+?\/\/.*$)|\/\*(.|[\n\r])*?\*\/)/gm;return n=>{const l=new $,c=[];return e.compose((()=>l.out),e.forEach((s=>{if("Array"==e.type(s))l.merge(s[0],s[1]);else if(s&&b(l,s,c),l.depth<1)throw new Error("lit-css parse error: unbalanced {} braces !")})),v,e.filter(e.complement(e.isEmpty)),e.map(e.trim),(i=s,s=>{const t=e.map(e.length,i),r=[];let n,l,c=0,a=i.length,o=s.length;for(n=0;n<o;n++)for(l=0;l<a;l++)s.slice(n,n+t[l])===i[l]&&"\\"!==s[n-1]&&(r.push(s.slice(c,n)),n+=t[l]-1,c=n+1);return c!==s.length-1&&r.push(s.slice(c)),r}),e.replace(/(\{|\})/g,((e,s,r,n)=>(t(n[r-1])||(s=";"+s),t(n[r+1])||(s+=";"),s))),u,e.replace(r,""))(n);var i}})(),k=(e,...s)=>S(((e,s)=>e.reduce(((e,t,r)=>e+t+(s.length>r?s[r]:"")),""))(e,s)),C=(e,s)=>e[s]||e[o(s)],j=(s,t,r,n)=>{switch(t||(t=i),typeof r){case a.f:return[r.name,[e=>r(e,n)]];case a.o:return[r.className,[e.always(r)]];case a.s:const l=((e,s,t)=>t.split(/[,\s\t]+/g).map((t=>[t,C(s,t)||C(e(),t)||i])))(s,t,r),c=[],o=[];for(const[e,r]of l)c.push(e),o.push(...j(s,t,r,n)[1]);return[c.join("_"),o];default:return["",[e.identity]]}},q={method:"f",defStyles:void 0,plugins:[],enhancers:[],preset:{unit:[]},ssr:!1};class _{static devClassNames=!1;renderer;_mixin;get mixin(){return Object.freeze(this._mixin)}get style(){return t.renderToMarkup(this.renderer)}constructor(o={}){const{method:u,ssr:p,preset:f,plugins:h,enhancers:d,...m}=((s,t={})=>e.compose(e.fromPairs,e.map((([s,r])=>{switch(e.type(r)){case"Array":return[s,[...r,...t[s]||[]]];case"Object":return[s,{...r,...t[s]||{}}];default:return[s,t[s]||r]}})),e.toPairs)(s))(q,o),y={...q.preset,...f||{}};if(o.fdef)throw new Error("fela-vue: Change deprecated `fdef` to `defStyles`!");this.renderer=s.createRenderer({...m,enhancers:d,plugins:[r(),n(),l(),c(...y.unit),...h]});const{renderer:w}=this,$=o.defStyles;let b,x;switch(typeof $){case a.o:[b,x]=[$.key,$.value];break;case a.f:[b,x]=["fdef",$]}console.log({isBrowser:g,ssr:p,renderer:w}),g&&(p?t.rehydrate(w):t.render(w)),this._mixin=e.filter(e.identity,{methods:{[u](e,t={}){const[r,n]=j((e=>{let s,t=!1;return()=>t?s:(t=!0,s=e())})((()=>x?x(this):i)),this.style,e,this);return w.renderRule(((e,s,t)=>{if(t&&s&&"anonymous"!==s)return{[s]:(s,t)=>e(s,t)}[s];return e})(s.combineRules(...n),r,_.devClassNames),t)||void 0}},computed:$&&{[b](){return x(this)}}})}}exports.Renderer=_,exports.SvelteRenderer=class extends _{static get devClassNames(){return _.devClassNames}static set devClassNames(e){_.devClassNames=e}f;fdef;getCSS(){return e=>{const s={style:e,fdef:this.fdef};return(e,t)=>this.f.call(s,e,t)}}getLiteralCSS(){const e=this.getCSS();return(...s)=>e(k(...s))}constructor(e={}){super(e);const s=this.mixin;this.f=s.methods.f,this.fdef="function"==typeof e.defStyles?s.computed.fdef:e.defStyles&&s.computed[e.defStyles.key]}},exports.css=k;
