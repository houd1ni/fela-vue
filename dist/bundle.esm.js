import{createRenderer as e,combineRules as t}from"fela";import{rehydrate as r,render as s,renderToMarkup as n}from"fela-dom";import c from"fela-plugin-embedded";import l from"fela-plugin-prefixer";import o from"fela-plugin-fallback-value";import i from"fela-plugin-unit";const a=function(){},u=e=>{let t=0;for(const r of e)r!==a&&t++;return t},f=(e,t)=>{const r=e.length,s=e.slice(),n=t.length;let c=n,l=0;for(;c&&l<r;l++)s[l]===a&&(s[l]=t[n-c],c--);for(l=r;c;l++,c--)s[l]=t[n-c];return s},h=(e,t,r)=>{const s=e.length-t.length-u(r);if(s<1)return e(...f(t,r));{const n=(...s)=>h(e,f(t,r),s);return n.$args_left=s,n}},p=e=>(...t)=>e.length>u(t)?h(e,[],t):e(...t),d=e=>typeof e,m=e=>null===e,g=e=>"number"==d(e),b={u:"U",b:"B",n:"N",s:"S",f:"F"},w=e=>{const t=d(e);return"object"===t?m(e)?"Null":e.constructor.name:b[t[0]]+t.slice(1)},y=p((e,t,r)=>r.reduce(e,t)),$=p((e,t,r)=>{for(let s in r)switch(w(r[s])){case"Array":if(e>1&&"Array"===w(t[s]))switch(e){case 2:const n=t[s],c=r[s];for(const t in c)n[t]?$(e,n[t],c[t]):n[t]=c[t];break;case 3:t[s].push(...r[s])}else t[s]=r[s];break;case"Object":if("Object"===w(t[s])){$(e,t[s],r[s]);break}default:t[s]=r[s]}return t}),N=($(1),$(2),$(3),p((e,t)=>{const r=w(e);if(r===w(t)&&("Object"===r||"Array"==r)){if(m(e)||m(t))return e===t;if(e===t)return!0;for(const r of[e,t])for(const s in r)if(!(r===t&&s in e||r===e&&s in t&&N(e[s],t[s])))return!1;return!0}return e===t})),v=p((e,t,r,s)=>e(s)?t(s):r(s)),j=p((e,t,r)=>v(e,t,z,r)),S=(...e)=>t=>{for(let r=A(e)-1;r>-1;r--)t=e[r](t);return t},x=p((e,t)=>t[e]),k=p((e,t,r)=>r.slice(e,g(t)?t:1/0)),C=x(0),O=(k(1,null),e=>m(e)||(e=>void 0===e)(e)),A=e=>e.length,_=e=>()=>e,z=e=>e,E=e=>e.trim(),B=e=>e[A(e)-1],W=e=>(...t)=>{const r=e(...t);return"function"===d(r)&&r.$args_left?W(r):!r},F=e=>Object.entries(e),U=p((e,t,r)=>({...r,[e]:t})),L=p((e,t)=>t[e]),R=p((e,t,r)=>v(A,()=>{return O(r)?e:S(v(O,_(e),r=>R(e,k(1,null,t),r)),(s=L,p((e,t)=>s(t,e)))(r),C)(t);var s},_(r),t)),Z=(R(void 0),/^(.*?)(8|16|32|64)(Clamped)?Array$/),q=e=>{const t=w(e);switch(t){case"Null":return e;case"Array":return I(q,e);case"Object":const r={};for(let t in e)r[t]=q(e[t]);return r;case"String":case"Number":case"Boolean":case"Symbol":return e;default:return Z.test(t)?I(q,e):e}},D=p((e,t,r)=>y(e,q(t),r)),G=e=>D((e,t)=>U(...t,e),{},e),H=p((e,t)=>t.join(e)),I=p((e,t)=>t.map(e)),J=p((e,t)=>t.forEach(e)),K=p((e,t,r)=>t(r)&&e(r)),M=e=>{switch(w(e)){case"String":case"Array":return 0==A(e);case"Object":for(const t in e)return!1;return!0;default:return null}},P=p((e,t,r)=>r.replace(e,t)),Q=p((e,t)=>{return r=t,Array.isArray(r)?t.filter(e):S(G,Q(([t,r])=>e(r,t)),F)(t);var r}),T=Object.freeze({}),V=Object.freeze({f:"function",o:"object",s:"string"}),X=e=>e.replace(/-(\w)/gu,(e,t)=>t.toUpperCase()),Y=(()=>{const e=/url\(.*?\)/g,t=/[,:;]/g;return r=>r.replace(e,e=>e.replace(t,e=>"\\"+e))})(),ee=j(W(O),P(/([^\\])\\([^\\])/g,"$1$2")),te=K(W(M),W(O)),re=S(N("Object"),w),se=S(N("Window"),w),ne=(e,t)=>{for(let r in t)re(e[r])&&re(t[r])?ne(e[r],t[r]):e[r]=t[r];return e},ce=(()=>{try{return se(window)}catch{return!1}})();class le{constructor(e){this.rules={};const t=e.match(/^\.[\w-_]+/);this.s={className:t?t[0].slice(1):null,modifier:t?e.slice(t[0].length)||null:e}}get complex(){return null!==this.s.className&&null!==this.s.modifier}serialize(){const{className:e,modifier:t}=this.s;return(e?"."+e:"")+(t||"")}}const oe=(e,t=0)=>{const r={};let s,n,c,l,o;for(o in e.rules)s=e.rules[o],s instanceof le?(n=s.complex?s.s.className:s.serialize(),c=0==t&&"."==n[0]?n.slice(1):"."==n[0]?"& "+n:n,l=s.complex?{[s.s.modifier]:oe(s,t+1)}:oe(s,t+1),r[c]?ne(r[c],l):r[c]=l):r[o]=s;return r};class ie{constructor(){this.path=[],this.path.push([new le("__root")])}get out(){return oe(this.path[0][0])}get depth(){return this.path.length}add(e){const t=B(this.path),r=[];for(const s of e){const e=new le(s);for(const s of t){const t=e.serialize(),n=s.rules[t];r.push(n||e),n||(s.rules[t]=e)}}this.path.push(r)}merge(e,t){if(te(t)&&te(e))for(const r of B(this.path))r.rules[e]=t}pop(){return this.path.pop()}}const ae=(()=>{const e=/^([\w-]+)(: *| +)(.*)$/,t=/^(([\|~\$@>\*\.:&\(\)\^="\-\[\]]+).*[ ,]*)+:?$/,r=/\s*,\s*/g,s=/(.*):$/;return(n,c,l)=>{let o;switch(!0){case"{"==c:n.add(l);break;case"}"==c:n.pop();break;case null!=(o=e.exec(c)):n.merge(ee(X(o[1])),j(isNaN,ee,(e=>{switch(e){case"undefined":case"":return;case"null":return null;default:return isNaN(+e)?e:+e}})(o[3])));break;case null!=(o=t.exec(c)):l.splice(0),l.push(...c.split(r).map(e=>e.replace(s,"$1")))}}})(),ue=(e,t)=>e[t]||e[X(t)],fe=(e,t,r,s)=>{switch(t||(t=T),typeof r){case V.f:return[r.name,[e=>r(e,s)]];case V.o:return[r.className,[_(r)]];case V.s:const n=((e,t,r)=>r.split(/[,\s\t]+/g).map(r=>[r,ue(t,r)||ue(e(),r)||T]))(e,t,r),c=[],l=[];for(const[r,o]of n)c.push(r),l.push(...fe(e,t,o,s)[1]);return[c.join("_"),l];default:return["",[z]]}},he={method:"f",defStyles:void 0,plugins:[],enhancers:[],preset:{unit:[]},ssr:!1};let pe=(()=>{class a{constructor(n={}){const{method:u,ssr:f,preset:h,plugins:p,enhancers:d,...m}=((e,t={})=>S(G,I(([e,r])=>{switch(w(r)){case"Array":return[e,[...r,...t[e]||[]]];case"Object":return[e,{...r,...t[e]||{}}];default:return[e,t[e]||r]}}),F)(e))(he,n),g={...he.preset,...h||{}};if(n.fdef)throw new Error("fela-vue: Change deprecated `fdef` to `defStyles`!");this.renderer=e({...m,enhancers:d,plugins:[c(),l(),o(),i(...g.unit),...p]});const{renderer:b}=this,y=n.defStyles;let $,N;switch(typeof y){case V.o:[$,N]=[y.key,y.value];break;case V.f:[$,N]=["fdef",y]}console.log({isBrowser:ce,ssr:f,renderer:b}),ce&&(f?r(b):s(b)),this._mixin=Q(z,{methods:{[u](e,r={}){const[s,n]=fe((e=>{let t,r=!1;return()=>r?t:(r=!0,t=e())})(()=>N?N(this):T),this.style,e,this);return b.renderRule(((e,t,r)=>{if(r&&t&&"anonymous"!==t){return{[t]:(t,r)=>e(t,r)}[t]}return e})(t(...n),s,a.devClassNames),r)||void 0}},computed:y&&{[$](){return N(this)}}})}get mixin(){return Object.freeze(this._mixin)}get style(){return n(this.renderer)}}return a.devClassNames=!1,a})();class de extends pe{constructor(e={}){super(e);const t=this.mixin;this.f=t.methods.f,this.fdef="function"==typeof e.defStyles?t.computed.fdef:e.defStyles&&t.computed[e.defStyles.key]}static get devClassNames(){return pe.devClassNames}static set devClassNames(e){pe.devClassNames=e}getCSS(){return e=>{const t={style:e,fdef:this.fdef};return(e,r)=>this.f.call(t,e,r)}}getLiteralCSS(){const e=this.getCSS();return(...t)=>e(ye(...t))}}const me=p(([e,t],r)=>{let s,n,c=r.length,l=e.length,o=0,i=[];for(s=0;s<c;s++)switch(r.slice(s,s+l)){case e:s+=l-1,0==o&&(n=s),o++;break;case t:if(s+=l-1,o--,0==o)i.push([n,s]);else if(o<0)throw new Error("fela-vue literal: unbalanced delimeter in functional expression !")}return i}),ge=S(H("\n"),I(e=>{const t=[];let r=0;for(let[s,n]of me(["[","]"],e))t.push(e.slice(r,s),`\${${e.slice(s+1,n).replace(/(\W|^)\$([a-zA-Z_]+)\b/g,"$1$$ps.$2").replace(/(\W|^)@(.+?)\b/g,"$1$t.$2")}}`),r=n+1;return t.push(e.slice(r)),t.join("")})),be=e=>{const t=[];let r,s,n,c=0,l=[];for(r of e)if(c>0)switch(r){case"{":c++,l[l.length-1]+=r;break;case"}":if(1==--c){const e=new Function("$t,css,$ps",`return css\`\n                ${ge(l)}\n              \``);t.push([n,(t,r)=>e(r,ye,t)]),c=0,l.splice(0)}else l[l.length-1]+=r;break;default:l.push(r)}else s=r.indexOf("=>"),~s?(c=1,n=r.slice(0,s).trim().replace(/^\./,"")):t.push(r);return t},we=(()=>{const e=["\n","\r",";"],t=t=>e.includes(t),r=/(([\s^]+?\/\/.*$)|\/\*(.|[\n\r])*?\*\/)/gm;return s=>{const n=new ie,c=[];return S(()=>n.out,J(e=>{if("Array"==w(e))n.merge(e[0],e[1]);else if(e&&ae(n,e,c),n.depth<1)throw new Error("lit-css parse error: unbalanced {} braces !")}),be,Q(W(M)),I(E),(l=e,e=>{const t=I(A,l),r=[];let s,n,c=0,o=l.length,i=e.length;for(s=0;s<i;s++)for(n=0;n<o;n++)e.slice(s,s+t[n])===l[n]&&"\\"!==e[s-1]&&(r.push(e.slice(c,s)),s+=t[n]-1,c=s+1);return c!==e.length-1&&r.push(e.slice(c)),r}),P(/(\{|\})/g,(e,r,s,n)=>(t(n[s-1])||(r=";"+r),t(n[s+1])||(r+=";"),r)),Y,P(r,""))(s);var l}})(),ye=(e,...t)=>we(((e,t)=>e.reduce((e,r,s)=>e+r+(t.length>s?t[s]:""),""))(e,t));export{pe as Renderer,de as SvelteRenderer,ye as css};
